steps:
  # Create the Cloud Run service
  - name: "Create Cloud Run service"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud run services create intellifix-integration

  # Retrieve .env file from Secrets Manager
  - name: "Retrieve .env file"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud secrets versions access latest --secret=intellifix-dotenv > /workspace/.env

  # Build Docker image
  - name: "Build Docker image"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        export DOCKER_BUILDKIT=1
        docker build \
          --progress=plain \
          -t "gcr.io/$PROJECT_ID/intellifix-integration:$SHORT_SHA" \
          --platform=linux/amd64 \
          .

  # Push Docker image
  - name: "Push Docker image"
    args: ["push", "gcr.io/$PROJECT_ID/intellifix-integration:$SHORT_SHA"]

  # Deploy to Cloud Run
  - name: "Deploy to Cloud Run"
    args:
      - "run"
      - "deploy"
      - "intellifix-integration"
      - "--image"
      - "gcr.io/$PROJECT_ID/intellifix-integration:$SHORT_SHA"
      - "--platform"
      - "managed"
      - "--region"
      - "global"
